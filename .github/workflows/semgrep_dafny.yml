name: Verification Gate (Dafny + Semgrep)

on:
  push:
  pull_request:

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Python deps (Semgrep)
        run: python3 -m pip install semgrep

      - name: Install Dafny (pinned)
        run: |
          set -eux
          DAFNY_VERSION=4.11.0
          curl -L -o dafny.zip "https://github.com/dafny-lang/dafny/releases/download/v${DAFNY_VERSION}/dafny-${DAFNY_VERSION}-x64-ubuntu-22.04.zip"
          unzip dafny.zip -d dafny
          echo "Contents of extracted folder:"
          ls -la dafny || true
          # Locate the dafny executable anywhere under the extracted folder
          DAFNY_BIN=$(find dafny -type f -name dafny -print -quit || true)
          if [ -z "${DAFNY_BIN}" ]; then
            echo "ERROR: could not find 'dafny' executable after unzip" >&2
            ls -R dafny >&2 || true
            exit 1
          fi
          echo "Found dafny binary at: ${DAFNY_BIN}"
          chmod +x "${DAFNY_BIN}"
          sudo ln -sf "${PWD}/${DAFNY_BIN}" /usr/local/bin/dafny
          which dafny
          dafny --version

      - name: Run verification gate
        run: python3 verify_gate/gate.py

      - name: Upload Dafny and Semgrep logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: verification-logs
          path: artifacts/
          retention-days: 30
