name: dafny-verify

on:
  push:
    paths: ['**/*.dfy', 'specs/**', '.github/workflows/verify.yml']
  pull_request:
    paths: ['**/*.dfy', 'specs/**', '.github/workflows/verify.yml']
  workflow_dispatch:

jobs:
  dafny:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Verify Dafny files via Docker Hub image
        run: |
          set -e
          mkdir -p artifacts

          docker run --rm -v "$PWD:/work" -w /work xtrm0/dafny:3.11.0 bash -lc '
            set -euo pipefail

            files=$(find . -type f -name "*.dfy" \
              -not -path "./.git/*" \
              -not -path "./node_modules/*")

            if [ -z "$files" ]; then
              echo "No .dfy files found"
              exit 0
            fi

            dafny /version | tee -a artifacts/dafny.log
